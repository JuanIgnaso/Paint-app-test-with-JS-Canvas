<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/output.css">
    <title>Canvas ğŸ–Œï¸</title>
</head>
<body class="bg-rose-100">


    <h1 class="p-2 text-center text-orange-400">ğŸ–Œï¸ Canvas ğŸ¨</h1>

    <main  class="flex flex-col justify-center">

        <!-- Borrar o descargar canvas -->
        <div class="flex flex-col items-center gap-3 p-2">
            <div class="flex gap-2">
                <!-- <button id="undo_btn" class="relative flex justify-center w-12 p-2 border-4 border-red-400 rounded-lg hover:border-red-600 group aspect-square bg-rose-200">â¬…ï¸<span class="absolute z-10 hidden p-1 text-sm rounded-lg pointer-events-none group-hover:block text-white/75 bg-slate-800/50 whitespace-nowrap">Undo</span></button>
                <button id="redo_btn" class="relative flex justify-center w-12 p-2 border-4 border-red-400 rounded-lg hover:border-red-600 group aspect-square bg-rose-200">â¡ï¸<span class="absolute z-10 hidden p-1 text-sm rounded-lg pointer-events-none group-hover:block text-white/75 bg-slate-800/50 whitespace-nowrap">Redo</span></button> -->
                <button id="clear_canvas" class="self-end p-2 font-bold text-red-600 border-4 border-red-400 rounded-lg shadow-inner shadow-black/50 hover:border-red-600 bg-rose-200">Clear Canvas</button>
                <button onclick="saveDrawing()" class="relative flex justify-center w-12 p-2 border-4 border-red-400 rounded-lg shadow-inner shadow-black/50 hover:border-red-600 group aspect-square bg-rose-200">ğŸ’¾<span class="absolute z-10 hidden p-1 text-sm rounded-lg pointer-events-none group-hover:block text-white/75 bg-slate-800/50 whitespace-nowrap">Download drawing</span></button>
            </div>
        </div>

        <!-- tamaÃ±o por defecto del canvas es de 300 x 150 -->
        <canvas  class="bg-white border-8 border-red-400 rounded-md " height="800px" width="1000px" id="myCanvas"></canvas>
        <div class="grid justify-center grid-cols-1 sm:grid-cols-2 md:grid-cols-3">

            <!-- Grosor del pincel -->
            <div class="flex flex-col items-center gap-3 p-2">
                <h4 class="text-orange-400">Line thickness</h4>
                <select name="" id="brush_thickness"  class="p-2 font-bold border-4 border-red-400 rounded-lg shadow-inner shadow-black/50 bg-rose-200 text-rose-600 hover:border-red-600">
                    <option value="1">Extra thin</option>
                    <option value="2">Thin</option>
                    <option value="4">Medium</option>
                    <option value="8">Thick</option>
                    <option value="16">Extra thick</option>
                </select>
            </div>

            <!-- Herramientas -->
            <div class="flex flex-col items-center gap-3 p-2">
                <h4 class="text-orange-400">Tools</h4>
                <div class="grid grid-cols-4 gap-2 justify-items-center lg:grid-cols-7 xl:grid-cols-8">
                    <button id="pencil" class="canvas-button bg-rose-200 tool group">ğŸ–Œï¸<span class="tool-name">Paint</span></button>
                    <button id="color_picker" class="canvas-button bg-rose-200 tool group">ğŸ©¸<span class="tool-name">Color Picker</span></button>
                    <button id="square" class="canvas-button tool group bg-rose-200">â¹ï¸<span class="tool-name">Draw square</span></button>
                    <button id="circle" onclick="console.log('hola')" class="canvas-button tool group bg-rose-200">â­•<span class="tool-name">Draw circle</span></button>
                    <button id="line" class="canvas-button tool group bg-rose-200">â–<span class="tool-name">Draw Line</span></button>
                    <button id="eraser" class="canvas-button tool group bg-rose-200">ğŸ’Š<span class="absolute z-10 hidden p-1 text-sm rounded-lg pointer-events-none group-hover:block text-white/75 bg-slate-800/50 whitespace-nowrap">Eraser</span></button>
                    <button class="canvas-button group bg-rose-200">ğŸª£<span class="tool-name">Color Bucket</span></button>
                </div>
                <div id="fill_figure_menu" class="hidden gap-3">
                    <label for="" class="flex gap-2">Fill<input type="radio" name="fill" id="1"></label>
                    <label for="" class="flex gap-2">No fill<input type="radio" name="fill" id="0"></label>
                </div>
            </div>

            <!-- Color actual -->
            <div class="flex flex-col items-center gap-3 p-2">
                <h4 class="text-orange-400">Current Color</h4>
                <div class="flex justify-center gap-3">
                    <div class="flex justify-center gap-2">
                        <span class="self-center font-bold text-red-600">Line color</span><div id="curr_stroke_color" class="relative flex justify-center w-12 p-2 bg-black border-4 border-red-400 rounded-lg shadow-inner shadow-black/50 group aspect-square"><input class="absolute opacity-0 cursor-pointer" type="color" name="" id="brush_color"></div>
                    </div>
                    <div class="flex justify-center gap-2"></div>
                        <span class="self-center font-bold text-red-600">Fill color</span><div id="curr_fill_color" class="relative flex justify-center w-12 p-2 bg-white border-4 border-red-400 rounded-lg shadow-inner shadow-black/50 group aspect-square"><input class="absolute opacity-0 cursor-pointer" type="color" name="" id="fill_color"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>


    <!-- SCRIPT -->
    <script>
        /*
        getBoundingClientRect() <- buscar en documentaciÃ³n, devuelve caracterÃ­sticas de elemento dom: x,y,top,bottom,left,right,height,width.
        */

        /*VARIABLES Y CONSTANTES**********************************************************************************/

        const canvas = document.getElementById("myCanvas");

        let ctx = canvas.getContext("2d"); //dar contexto, en este caso dibujo 2D.

        let strokeCurrentColor = '#000000'; //Guarda el color actual

        let fillCurrentColor = '#ffffff'; //Guarda el color de relleno actual

        ctx.strokeStyle = strokeCurrentColor; //Color por defecto del pincel.

        ctx.lineWidth = 4; //Grosor por defecto del pincel.

        const brush_color = document.querySelector('#brush_color'); //Input de color para cambiar el color del trazo.

        const fill_color = document.querySelector('#fill_color'); //Input de color para cambiar color del relleno

        let isMousePressed = false; //Determinar si estÃ¡ presionando el ratÃ³n.

        let coords = {x:0,y:0}; //Coordenandas del ratÃ³n

        let toolType;

        let shapeStart = false;

        let square = {'x':undefined,'y':undefined,'width':undefined,'height':undefined};
        //arc(x,y,diametro,0, Math.PI * 2,true)
        let circle = {'x':undefined,'y':undefined};

        /************************************************************************************************/


        //FUNCIONES----------------------------------------------------------------------------------

        /*
        Cambia el tamaÃ±o canvas cuando se redimensiona la ventana
        */
        function resize(){
        ctx.canvas.width = window.innerWidth;
        ctx.canvas.height = window.innerHeight;
        }

        /*
        Recoge y actualiza la posiciÃ³n del ratÃ³n del usuario.
        */
        function getPosition(event){
            /*evitar que desincronice la posiciÃ³n del pincel al hacer scroll*/
            coords.x = (event.clientX - canvas.getBoundingClientRect().left) / canvas.getBoundingClientRect().width * canvas.getBoundingClientRect().width;
            coords.y = (event.clientY - canvas.getBoundingClientRect().top) / canvas.getBoundingClientRect().height * canvas.getBoundingClientRect().height;
        }


        /*Cambiar grosor del pincel*/
        document.querySelector('#brush_thickness').addEventListener('change',function(){
            ctx.lineWidth = Number(this.value);
        });


       /*
       Convertir el canvas en imagen para que el usuario la pueda descargar como imÃ¡gen.
       */
       function saveDrawing(){
            var img = canvas.toDataURL('image/png');
            localStorage.setItem('lastDrawing',img);
            window.open('./saveCanvas.html','_self'); //redirige el usuario a saveCanvas.html
       }

        /*
        EvalÃºa el estado 'isMousePressed' y dibuja llamando a la funciÃ³n drawPath si 'pencil' o 'eraser'
        estÃ¡n seleccionados.
        */
        function draw(event) {
            //Dibuja en caso de que el ratÃ³n estÃ© siendo presionado.
            if(isMousePressed){
                ctx.lineCap = 'round';
                /*Si el usuario estÃ¡ usando la goma de borrar, se cambia el pincel al color blanco*/

                if(toolType == 'eraser'){
                    ctx.strokeStyle = '#ffffff';
                    drawPath(event);
                }

                if(toolType == 'pencil'){
                    ctx.strokeStyle = strokeCurrentColor;
                    drawPath(event);
                }
            }
        }

        /*Dibuja el trazado en el canvas*/
        function drawPath(event){
            ctx.beginPath();
            ctx.moveTo(coords.x,coords.y);
            getPosition(event);
            ctx.lineTo(coords.x,coords.y);
            ctx.stroke();
        }

        /*
        Cambia la forma con la cual se interactua con el canvas dependiendo del valor que tenga la variable
        'toolType'
        */
        function useTool(event){
            //Dibujar lÃ­nea
            if(toolType == 'line'){
                ctx.strokeStyle = strokeCurrentColor;
                getPosition(event);
                if(!shapeStart){
                    shapeStart = true;
                    ctx.beginPath();
                    ctx.moveTo(coords.x,coords.y);
                    showRef(event);
                }else{
                    ctx.lineTo(coords.x,coords.y);
                    ctx.stroke();
                    ctx.save();
                    shapeStart = false;
                }
            }
            //Dibujar cuadrado
            if(toolType == 'square'){
                //<div class="absolute w-4 h-4 border-2 border-blue-600/50 bg-blue-300/50 rounded-full"></div>
                ctx.strokeStyle = strokeCurrentColor;
                if(!shapeStart){
                    shapeStart = true;
                    getPosition(event);
                    square.x = coords.x;
                    square.y = coords.y;
                    showRef(event);
                }else{
                    getPosition(event);
                    square.height = coords.y - square.y;
                    square.width = coords.x - square.x;
                    ctx.fillRect(square.x, square.y, square.width, square.height);
                    ctx.strokeRect(square.x, square.y, square.width, square.height);
                    square.x = square.y = square.width = square.height = undefined;
                    shapeStart = false;
                    ctx.save();
                    removeRef();
                }
            }
            //Dibujar un cÃ­rculo
            if(toolType == 'circle'){
                console.log(toolType);
                ctx.strokeStyle = strokeCurrentColor;
                getPosition(event);
                if(!shapeStart){
                    shapeStart = true;
                    ctx.beginPath();
                    circle.x = coords.x;
                    circle.y = coords.y;
                    showRef(event);
                }else{
                    getPosition(event);
                    let clockWise = coords.x >= circle.x;
                    ctx.arc(circle.x,circle.y,Math.abs(coords.x - circle.x),0, Math.PI * 2,clockWise);
                    ctx.fill();
                    ctx.stroke();
                    circle.x = circle.y = undefined;
                    shapeStart = false;
                    removeRef();
                }
            }
            //Cuentagotas
            if(toolType == 'color_picker'){
                let color = ctx.getImageData(coords.x,coords.y,1,1).data;
                strokeCurrentColor = `rgb(${color[0]},${color[1]},${color[2]})`;
                ctx.strokeStyle = strokeCurrentColor;
            }
        }

        /*
        Muestra la referencia del Ãºltimo punto
        */

        function showRef(event){
            var ref = document.createElement('div');
            ref.setAttribute('id','ref');
            ref.setAttribute('class','absolute w-4 h-4 border-2 border-blue-600/50 bg-blue-300/50 rounded-full');
            ref.style.left = event.pageX + 'px';
            ref.style.top = event.pageY + 'px';
            document.body.appendChild(ref);
        }

        removeRef = () =>{document.querySelector('#ref').remove();};

        /*
        Limpia el Canvas
        */
        function clearCanvas(){
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.rect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
        }


        /*EVENTLISTENERS**********************************************************************************/
        /*
        Se cargan los siguientes eventlisteners al cargar la pÃ¡gina
        */
        window.addEventListener('load',()=>{

            resize();

            /*Define el color de fondo del canvas y evita que quede transparente*/
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#ffffff";
            ctx.fill();
            toolType = 'pencil';

            document.querySelector('#clear_canvas').addEventListener('click',clearCanvas); //Limpiar el canvas

            canvas.addEventListener('mousedown',(e)=> {isMousePressed = true; getPosition(e)});

            document.addEventListener("mousemove", draw);

            document.addEventListener('mouseup',() => { isMousePressed = false;});

            canvas.addEventListener('click',(e)=>useTool(e));

            /*Muestra al usuario el color actual del pincel*/
            brush_color.addEventListener('change',function(){
                    strokeCurrentColor = this.value;
                    ctx.strokeStyle = strokeCurrentColor;
                    document.querySelector('#curr_stroke_color').style.backgroundColor = strokeCurrentColor;
            });

            fill_color.addEventListener('change',function(){
                fillCurrentColor = this.value;
                ctx.fillStyle = fillCurrentColor;
                document.querySelector('#curr_fill_color').style.backgroundColor = fillCurrentColor;
            });

            /*
            AÃ±adir evento a las herramientas para cambiar el 'toolType' actual
            */
            document.querySelectorAll(".tool").forEach(element => {
                element.addEventListener("click", function(e){
                    toolType = e.target.closest(".tool").id;
                    document.querySelectorAll('.tool').forEach(e =>{
                        e.classList.replace('bg-rose-400','bg-rose-200');
                    }
                    );
                    element.classList.replace('bg-rose-200','bg-rose-400');
                });
            });
        });
    </script>

    <!-- FOOTER DE LA PÃGINA -->
        <footer class="text-center pl-4 pt-4 pr-4 pb-2  bg-rose-300">

            <div class="border-2 border-white m-auto w-3/4 lg:w-1/2 mt-8 mb-8"></div>
                <section class="flex flex-col md:flex-row justify-center gap-8">
                    <p class="text-4xl font-extrabold text-rose-600">Canvas Web App</p>

                    <ol class="flex flex-col items-center md:items-start gap-2">
                        <li><p class="text-2xl font-extrabold text-rose-500 border-b-2 border-white/50">Contactos</p></li>
                        <li class=""><a class="text-rose-100 font-bold" href="https://github.com/JuanIgnaso">GitHub</a></li>
                        <li class=""> <a class="text-rose-100 font-bold" href="https://www.linkedin.com/in/juan-ignacio-navarrete-soli%C3%B1o-935308282/">Linkedin</a></li>
                    </ol>
                </section>
                <span class="mt-2 block text-sm text-center text-rose-100 sm:text-right">Â© 2024 <strong class="hover:underline">Juan Navarrete</strong></span>
        </footer>
</body>
</html>