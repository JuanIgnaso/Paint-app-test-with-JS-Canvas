<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/output.css">
    <title>Canvas üñåÔ∏è</title>
</head>
<body class="bg-rose-100">


    <h1 class="p-2 text-center text-orange-400">üñåÔ∏è Canvas üé®</h1>

    <main  class="flex flex-col justify-center">

        <!-- Borrar o descargar canvas -->
        <div class="flex flex-col items-center gap-3 p-2">
            <div class="flex gap-2">
                <button id="undo_btn" class="relative flex justify-center w-12 p-2 border-4 border-red-400 rounded-lg hover:border-red-600 group aspect-square bg-rose-200">‚¨ÖÔ∏è<span class="absolute z-10 hidden p-1 text-sm rounded-lg pointer-events-none group-hover:block text-white/75 bg-slate-800/50 whitespace-nowrap">Undo</span></button>
                <button id="redo_btn" class="relative flex justify-center w-12 p-2 border-4 border-red-400 rounded-lg hover:border-red-600 group aspect-square bg-rose-200">‚û°Ô∏è<span class="absolute z-10 hidden p-1 text-sm rounded-lg pointer-events-none group-hover:block text-white/75 bg-slate-800/50 whitespace-nowrap">Redo</span></button>
                <button id="clear_canvas" class="self-end p-2 font-bold text-red-600 border-4 border-red-400 rounded-lg shadow-inner shadow-black/50 hover:border-red-600 bg-rose-200">Clear Canvas</button>
                <button onclick="saveDrawing()" class="relative flex justify-center w-12 p-2 border-4 border-red-400 rounded-lg shadow-inner shadow-black/50 hover:border-red-600 group aspect-square bg-rose-200">üíæ<span class="absolute z-10 hidden p-1 text-sm rounded-lg pointer-events-none group-hover:block text-white/75 bg-slate-800/50 whitespace-nowrap">Download drawing</span></button>
            </div>
        </div>

        <!-- tama√±o por defecto del canvas es de 300 x 150 -->
            <canvas class="relative w-full h-full bg-white border-8 border-red-400 cursor-crosshair " id="mainCanvas"></canvas>
        <div class="grid justify-center grid-cols-1 sm:grid-cols-2 md:grid-cols-3">

            <!-- Grosor del pincel -->
            <div class="flex flex-col items-center gap-3 p-2">
                <h4 class="text-orange-400">Line thickness</h4>
                <label for="" class="flex items-center gap-3 font-bold text-red-600">Choose brush thikness<input type="range" name="" id="brush_thickess" min="1" max="100" class=" accent-orange-400"></label>

            </div>

            <!-- Herramientas -->
            <div class="flex flex-col items-center gap-3 p-2">
                <h4 class="text-orange-400">Tools</h4>
                <div class="grid grid-cols-4 gap-2 justify-items-center lg:grid-cols-7 xl:grid-cols-8">
                    <button id="pencil" class="canvas-button bg-rose-200 tool group has-[:checked]:bg-rose-400"><input type="radio" name="tool" id="pencil" class="absolute opacity-0 cursor-pointer">üñåÔ∏è<span class="tool-name">Paint</span></button>
                    <button id="color_picker" class="canvas-button bg-rose-200 tool group has-[:checked]:bg-rose-400">ü©∏<input type="radio" name="tool" id="color_picker" class="absolute opacity-0 cursor-pointer"><span class="tool-name">Color Picker</span></button>
                    <button id="square" class="canvas-button tool group bg-rose-200 has-[:checked]:bg-rose-400">‚èπÔ∏è<input type="radio" name="tool" id="square" class="absolute opacity-0 cursor-pointer"><span class="tool-name">Draw square</span></button>
                    <button id="circle" class="canvas-button tool group bg-rose-200 has-[:checked]:bg-rose-400">‚≠ï<input type="radio" name="tool" id="circle" class="absolute opacity-0 cursor-pointer"><span class="tool-name">Draw circle</span></button>
                    <button id="line" class="canvas-button tool group bg-rose-200 has-[:checked]:bg-rose-400">‚ûñ<input type="radio" name="tool" id="line" class="absolute opacity-0 cursor-pointer"><span class="tool-name">Draw Line</span></button>
                    <button id="eraser" class="canvas-button tool group bg-rose-200 has-[:checked]:bg-rose-400">üíä<input type="radio" name="tool" id="eraser" class="absolute opacity-0 cursor-pointer"><span class="absolute z-10 hidden p-1 text-sm rounded-lg pointer-events-none group-hover:block text-white/75 bg-slate-800/50 whitespace-nowrap">Eraser</span></button>
                    <button class="canvas-button group bg-rose-200">ü™£<span class="tool-name">Color Bucket</span></button>
                </div>
                <div id="fill_figure_menu" class="hidden gap-3">
                    <label for="" class="flex gap-2">Fill<input type="radio" name="fill" id="fillyes"></label>
                    <label for="" class="flex gap-2">No fill<input type="radio" name="fill" id="fillno"></label>
                </div>
            </div>

            <!-- Color actual -->
            <div class="flex flex-col items-center gap-3 p-2">
                <h4 class="text-orange-400">Current Color</h4>
                <div class="flex justify-center gap-3">
                    <div class="flex justify-center gap-2">
                        <span class="self-center font-bold text-red-600">Line color</span><div id="curr_stroke_color" class="relative flex justify-center w-12 p-2 bg-black border-4 border-red-400 rounded-lg shadow-inner shadow-black/50 group aspect-square"><input class="absolute opacity-0 cursor-pointer" type="color" name="" id="brush_color"></div>
                    </div>
                    <div class="flex justify-center gap-2"></div>
                        <span class="self-center font-bold text-red-600">Fill color</span><div id="curr_fill_color" class="relative flex justify-center w-12 p-2 bg-white border-4 border-red-400 rounded-lg shadow-inner shadow-black/50 group aspect-square"><input class="absolute opacity-0 cursor-pointer" type="color" name="" id="fill_color"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- SCRIPT -->

    <script>
        /*VARIABLES Y CONSTANTES**********************************************************************************/

        const canvas = document.getElementById("mainCanvas");

        let ctx = canvas.getContext("2d"); //dar contexto, en este caso dibujo 2D.

        let strokeCurrentColor = '#000000'; //Guarda el color actual

        let fillCurrentColor = '#ffffff'; //Guarda el color de relleno actual

        ctx.strokeStyle = strokeCurrentColor; //Color por defecto del pincel.

        const brush_color = document.querySelector('#brush_color'); //Input de color para cambiar el color del trazo.

        const fill_color = document.querySelector('#fill_color'); //Input de color para cambiar color del relleno

        const fill_menu = document.querySelector('#fill_figure_menu');

        let isMousePressed = false; //Determinar si est√° presionando el rat√≥n.

        let coords = {x:0,y:0}; //Coordenandas del rat√≥n

        let toolType;

        let shapeStart = false;

        let undo_array = [];

        let redo_array = [];

        let square = {'x':undefined,'y':undefined,'width':undefined,'height':undefined};
        //arc(x,y,diametro,0, Math.PI * 2,true)
        let circle = {'x':undefined,'y':undefined};

        /************************************************************************************************/

        //FUNCIONES----------------------------------------------------------------------------------

        /*
        Cambia el tama√±o canvas cuando se redimensiona la ventana //<- motivo del desincronizar al cambiar el tama√±o de ventana es porque solo
        se ejecuta cuando carga el documento(load)
        */
        function resize(){
        ctx.canvas.height = window.innerHeight;
        ctx.canvas.width = window.innerWidth;
        console.log(ctx.canvas.width);
        }

        /*
        Recoge y actualiza la posici√≥n del rat√≥n del usuario.
        */
        function getPosition(event){
            /*evitar que desincronice la posici√≥n del pincel al hacer scroll*/
            coords.x = (event.clientX - canvas.getBoundingClientRect().left) / canvas.getBoundingClientRect().width * canvas.getBoundingClientRect().width;
            coords.y = (event.clientY - canvas.getBoundingClientRect().top) / canvas.getBoundingClientRect().height * canvas.getBoundingClientRect().height;
        }

       /*
       Convertir el canvas en imagen para que el usuario la pueda descargar como im√°gen.
       */
       function saveDrawing(){
            localStorage.setItem('lastDrawing',canvas.toDataURL('image/png'));
            window.open('./saveCanvas.html','_self'); //redirige el usuario a saveCanvas.html
       }

        /*
        Funci√≥n encargada de realizar un trazado cuando el usuario mueve el rat√≥n manteniendo presionado.
        */
        function draw(event) {
            if(isMousePressed){
                ctx.lineCap = 'round';
                if(toolType == 'eraser' || toolType == 'pencil'){
                    drawPath(event);
                }
                /*Si se usa la goma se cambia a color blanco, si no se vuelve al color actual*/
                ctx.strokeStyle = toolType == 'eraser' ? '#ffffff' : strokeCurrentColor;
            }
        }

        /*Dibuja el trazado en el canvas*/
        function drawPath(event){
            ctx.beginPath();
            ctx.moveTo(coords.x,coords.y);
            getPosition(event);
            ctx.lineTo(coords.x,coords.y);
            ctx.stroke();
        }

        /*
        Cambia la forma con la cual se interactua con el canvas dependiendo del valor que tenga la variable
        'toolType'
        */
        function useTool(event){
            //Dibujar l√≠nea
            if(toolType == 'line'){
                ctx.strokeStyle = strokeCurrentColor;
                getPosition(event);
                if(!shapeStart){
                    shapeStart = true;
                    ctx.beginPath();
                    ctx.moveTo(coords.x,coords.y);
                    showRef(event);
                }else{
                    ctx.lineTo(coords.x,coords.y);
                    ctx.stroke();
                    shapeStart = false;
                    save_last();
                    removeRef();
                }
            }
            //Dibujar cuadrado
            if(toolType == 'square'){
                //<div class="absolute w-4 h-4 border-2 rounded-full border-blue-600/50 bg-blue-300/50"></div>
                if(!shapeStart){
                    shapeStart = true;
                    getPosition(event);
                    square.x = coords.x;
                    square.y = coords.y;
                    showRef(event);
                }else{
                    getPosition(event);
                    square.height = coords.y - square.y;
                    square.width = coords.x - square.x;

                    if(document.querySelector('#fillyes').checked){
                    ctx.fillRect(square.x, square.y, square.width, square.height);
                    }

                    ctx.strokeRect(square.x, square.y, square.width, square.height);
                    square.x = square.y = square.width = square.height = undefined;
                    shapeStart = false;
                    save_last();
                    removeRef();
                }
            }
            //Dibujar un c√≠rculo
            if(toolType == 'circle'){
                console.log(toolType);
                getPosition(event);
                if(!shapeStart){
                    shapeStart = true;
                    ctx.beginPath();
                    circle.x = coords.x;
                    circle.y = coords.y;
                    showRef(event);
                }else{
                    getPosition(event);
                    let clockWise = coords.x >= circle.x;
                    ctx.arc(circle.x,circle.y,Math.abs(coords.x - circle.x),0, Math.PI * 2,clockWise);

                    if(document.querySelector('#fillyes').checked){
                    ctx.fill();
                    }

                    ctx.stroke();
                    circle.x = circle.y = undefined;
                    shapeStart = false;
                    removeRef();
                    save_last();
                }
            }
            //Cuentagotas
            if(toolType == 'color_picker'){
                let color = ctx.getImageData(coords.x,coords.y,1,1).data;
                strokeCurrentColor = `rgb(${color[0]},${color[1]},${color[2]})`;
                ctx.strokeStyle = strokeCurrentColor;
            }
        }

        /*
        Muestra la referencia del √∫ltimo punto
        */

        function showRef(event){
            var ref = document.createElement('div');
            ref.setAttribute('id','ref');
            ref.setAttribute('class','absolute w-4 h-4 border-2 border-blue-600/50 bg-blue-300/50 rounded-full');
            ref.style.left = event.pageX + 'px';
            ref.style.top = event.pageY + 'px';
            document.body.appendChild(ref);
        }

        removeRef = () =>{document.querySelector('#ref').remove();};

        /*
        Limpia el Canvas
        */
        function clearCanvas(){
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.rect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            undo_array = redo_array = [];
        }

        /*Guarda la √∫ltima acci√≥n hecha por el usuario*/
        function save_last(){
            undo_array.push(ctx.getImageData(0,0,canvas.width,canvas.height));
            redo_array = [];
        }

        /*Se encargar del historial del dibujo*/
        function undoRedo(pushStack,popStack){
                pushStack.push(popStack.pop());
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.putImageData(undo_array[undo_array.length - 1],0,0);
        }

        /*EVENTLISTENERS**********************************************************************************/
        /*
        Se cargan los siguientes eventlisteners al cargar la p√°gina
        */
        window.addEventListener('load',()=>{

            resize();

            /*Define el color de fondo del canvas y evita que quede transparente*/
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#ffffff";
            ctx.fill();

            toolType = 'pencil';

            document.querySelector('#clear_canvas').addEventListener('click',clearCanvas); //Limpiar el canvas

            canvas.addEventListener('mousedown',(e)=> {isMousePressed = true; getPosition(e)});

            canvas.addEventListener("mousemove", draw);

            canvas.addEventListener('mouseup',function(){
                isMousePressed = false;
                save_last();
            });

            canvas.addEventListener('click',(e)=>useTool(e));

            /*Muestra al usuario el color actual del pincel y del relleno--*/
            brush_color.addEventListener('change',function(){
                ctx.strokeStyle = strokeCurrentColor = this.value;
                document.querySelector('#curr_stroke_color').style.backgroundColor = this.value;
            });

            fill_color.addEventListener('change',function(){
                ctx.fillStyle = fillCurrentColor = this.value;
                document.querySelector('#curr_fill_color').style.backgroundColor = this.value;
            });
            /*-----------------------------------------------------------*/

            /*CAMBIAR GROSOR DEL PINCEL-----------------------------------*/
            document.querySelector('#brush_thickess').addEventListener('change',function(){
                ctx.lineWidth = Number(this.value);
            });

            //HACER Y DESHACER CAMBIOS
            document.querySelector('#undo_btn').addEventListener('click',function(){
                undo_array.length > 1 ?  undoRedo(redo_array,undo_array) : ctx.clearRect(0,0,canvas.width,canvas.height);
            });

            document.querySelector('#redo_btn').addEventListener('click',function(){
                redo_array.length >= 1 ? undoRedo(undo_array,redo_array) : '';
            });

            /*
            A√±adir evento a las herramientas para cambiar el 'toolType' actual, si es 'circle' o 'square' se muestra un men√∫ de relleno
            */
            document.querySelectorAll("input[name='tool']").forEach(element => {
                if(element.checked){
                        toolType = element.getAttribute('id');
                }
                element.addEventListener("click", function(e){
                    toolType = e.target.id;

                    if(toolType == 'circle' || toolType == 'square'){
                        fill_menu.classList.replace('hidden','flex');
                    }else{
                        fill_menu.classList.replace('flex','hidden');
                    }
                });
            });
        });
    </script>

    <!-- FOOTER DE LA P√ÅGINA -->
        <footer class="pt-4 pb-2 pl-4 pr-4 text-center bg-rose-300">

            <div class="w-3/4 m-auto mt-8 mb-8 border-2 border-white lg:w-1/2"></div>
                <section class="flex flex-col justify-center gap-8 md:flex-row">
                    <p class="text-4xl font-extrabold text-rose-600">Canvas Web App</p>

                    <ol class="flex flex-col items-center gap-2 md:items-start">
                        <li><p class="text-2xl font-extrabold border-b-2 text-rose-500 border-white/50">Contactos</p></li>
                        <li class=""><a class="font-bold text-rose-100" href="https://github.com/JuanIgnaso">GitHub</a></li>
                        <li class=""> <a class="font-bold text-rose-100" href="https://www.linkedin.com/in/juan-ignacio-navarrete-soli%C3%B1o-935308282/">Linkedin</a></li>
                    </ol>
                </section>
                <span class="block mt-2 text-sm text-center text-rose-100 sm:text-right">¬© 2024 <strong class="hover:underline">Juan Navarrete</strong></span>
        </footer>
</body>
</html>